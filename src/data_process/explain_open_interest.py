#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""持仓量概念详解"""

print("=" * 80)
print("持仓量（Open Interest）概念详解")
print("=" * 80)

print("""
❌ 常见误解：
   "持仓量 = 我自己的持仓量"
   
✅ 正确理解：
   "持仓量 = 整个市场所有人的未平仓合约总数"

""")

print("=" * 80)
print("1. 什么是持仓量（Open Interest）")
print("=" * 80)

print("""
定义：
  持仓量是指某一时刻，市场上所有投资者持有的、
  尚未平仓的期货合约总数量。
  
特点：
  ✓ 这是市场层面的数据，不是个人数据
  ✓ 反映市场整体的参与程度
  ✓ 每个合约都有自己的持仓量
  ✓ 持仓量只统计单边（不重复计算多空）

计数方式：
  一个买方 + 一个卖方 = 1手持仓量
  （不是2手！因为每笔交易有买有卖）
""")

print("=" * 80)
print("2. 持仓量 vs 个人持仓 vs 成交量")
print("=" * 80)

print("""
┌─────────────────────────────────────────────────────────────┐
│ 概念对比                                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 📊 市场持仓量（Open Interest）                              │
│    └─ 全市场所有人的未平仓合约总数                          │
│    └─ 数据来源：交易所公布                                  │
│    └─ 单位：手                                              │
│    └─ 示例：螺纹钢RB2505合约持仓量100万手                   │
│                                                             │
│ 👤 个人持仓（Position）                                     │
│    └─ 你自己账户里持有的合约数                              │
│    └─ 数据来源：你的交易账户                                │
│    └─ 单位：手                                              │
│    └─ 示例：你持有10手RB2505多单                            │
│                                                             │
│ 💹 成交量（Volume）                                         │
│    └─ 一段时间内完成的交易数量                              │
│    └─ 数据来源：交易所统计                                  │
│    └─ 单位：手                                              │
│    └─ 示例：今天RB2505成交50万手                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
""")

print("=" * 80)
print("3. 持仓量的变化示例")
print("=" * 80)

print("""
假设螺纹钢RB2505合约的持仓量变化：

初始状态：持仓量 = 1000手

情况1：新资金入场（开仓交易）
  - 小明买入10手（开多仓）
  - 小红卖出10手（开空仓）
  - 结果：持仓量 = 1000 + 10 = 1010手 ⬆️
  - 解释：新增了10手未平仓合约

情况2：资金离场（平仓交易）
  - 老王平掉10手多单
  - 老李平掉10手空单
  - 结果：持仓量 = 1010 - 10 = 1000手 ⬇️
  - 解释：减少了10手未平仓合约

情况3：换手（一开一平）
  - 小张买入10手（开多仓）
  - 老王卖出10手（平多仓）
  - 结果：持仓量 = 1000手 ➡️
  - 解释：总持仓量不变，只是换了持有人
""")

print("=" * 80)
print("4. 持仓量在交易中的实际意义")
print("=" * 80)

print("""
⭐ 市场深度指标：
   持仓量大 → 市场活跃、流动性好、容易成交
   持仓量小 → 市场冷清、流动性差、可能滑点大

⭐ 资金流向判断：
   持仓量增加 + 价格上涨 → 多头入场，强势
   持仓量增加 + 价格下跌 → 空头入场，弱势
   持仓量减少 + 价格上涨 → 空头止损，可能反转
   持仓量减少 + 价格下跌 → 多头止损，可能反转

⭐ 合约活跃度：
   主力合约：持仓量最大的合约（如RB2505）
   次主力：持仓量第二的合约（如RB2506）
   非主力：持仓量小，不建议交易
""")

print("=" * 80)
print("5. 策略中如何使用持仓量")
print("=" * 80)

print("""
# 示例1：判断市场强弱
if price_up and open_interest_up:
    # 价格上涨 + 持仓量增加 = 多头强势
    signal = "强势上涨"
elif price_up and open_interest_down:
    # 价格上涨 + 持仓量减少 = 空头回补，可能见顶
    signal = "可能反转"

# 示例2：过滤非主力合约
if open_interest < 10000:
    # 持仓量太小，流动性差，不交易
    return

# 示例3：判断合约换月时机
if open_interest_new > open_interest_old:
    # 新合约持仓量超过老合约，该换月了
    switch_contract()
""")

print("=" * 80)
print("6. 个人持仓的跟踪")
print("=" * 80)

print("""
在VeighNa策略中，你的个人持仓通过 self.pos 跟踪：

class MyStrategy(CtaTemplate):
    def on_bar(self, bar):
        # 查看你自己的持仓
        my_position = self.pos  # 正数=多仓，负数=空仓，0=无仓位
        
        if my_position == 0:
            print("我当前无持仓")
        elif my_position > 0:
            print(f"我持有{my_position}手多单")
        else:
            print(f"我持有{abs(my_position)}手空单")
        
        # 注意：self.pos 是你的持仓
        #      bar.open_interest 是市场持仓量
        #      完全是两回事！
""")

print("=" * 80)
print("7. 为什么你的数据中持仓量为0")
print("=" * 80)

print("""
原因：
  聚宽的分钟级数据可能不包含持仓量字段
  或者持仓量只在日线级别提供

影响：
  ✓ 对大多数价格策略没影响
  ✓ OHLC和成交量数据完整就够用了
  ✗ 如果策略需要持仓量，需要：
    - 使用日线数据
    - 或换其他数据源（如RQData）
    - 或不使用持仓量指标
""")

print("=" * 80)
print("总结")
print("=" * 80)

print("""
┌─────────────────────────────────────────────────────┐
│ 重点记住：                                          │
│                                                     │
│ ✓ 持仓量 = 市场总持仓，不是你的持仓                 │
│ ✓ 个人持仓在策略中用 self.pos 查看                  │
│ ✓ 持仓量反映市场热度和资金流向                      │
│ ✓ 大多数策略不需要持仓量也能运行良好                │
│                                                     │
└─────────────────────────────────────────────────────┘
""")

